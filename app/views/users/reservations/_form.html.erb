<div class="min-h-screen bg-gradient-to-br from-sky-50 to-blue-50 py-8 pb-24 overflow-visible">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 overflow-visible">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-sky-800 mb-2">ğŸ“… æ–°è¦äºˆç´„</h1>
      <p class="text-sky-600">å¸Œæœ›ã®æ™‚é–“æ ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    </div>

    <%= form_with model: [:users, @reservation], local: true, class: "space-y-8 overflow-visible pb-24" do |f| %>
  <% if @reservation.errors.any? %>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
              <div class="mt-2 text-sm text-red-700">
                <ul class="list-disc pl-5 space-y-1">
        <% @reservation.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- æ™‚é–“æ é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ• æ™‚é–“æ ã‚’é¸æŠ</h2>
        
        <div data-controller="calendar" class="space-y-4">
          <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼ã®æ™‚é–“æ é¸æŠ -->
          <div class="calendar-container mt-2 mb-2 overflow-x-auto">
            <table class="calendar-table w-full border-collapse">
              <thead>
                <tr class="bg-gray-50">
                  <th class="border border-gray-200 px-4 py-2 text-left font-medium text-gray-700">æ—¥ä»˜</th>
                  <% @all_slots.group_by { |s| s.start_time.strftime('%H:%M') }.keys.sort.each do |time| %>
                    <th class="border border-gray-200 px-4 py-2 text-center font-medium text-gray-700"><%= time %></th>
                  <% end %>
                </tr>
              </thead>
              <tbody>
                <% @all_slots.group_by { |s| s.start_time.to_date }.each do |date, slots| %>
                  <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2 text-sm font-medium text-gray-900">
                      <%= date.strftime('%m/%dï¼ˆ%aï¼‰') %>
                    </td>
                    <% @all_slots.group_by { |s| s.start_time.strftime('%H:%M') }.keys.sort.each do |time| %>
                      <% slot = slots.find { |s| s.start_time.strftime('%H:%M') == time } %>
                      <td class="border border-gray-200 px-2 py-2 text-center">
                        <% if slot %>
                          <% is_reserved = @reserved_slot_ids.include?(slot.id) %>
            <button
              type="button"
                            class="calendar-slot-btn w-full px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 <%= is_reserved ? 'bg-red-100 text-red-700 cursor-not-allowed' : 'bg-sky-100 hover:bg-sky-300 hover:scale-105 text-sky-700 shadow-sm hover:shadow-md' %>"
              data-action="click->calendar#selectSlot"
              data-slot-id="<%= slot.id %>"
                            data-slot-time="<%= slot.start_time.strftime('%H:%M') %>"
                            data-slot-date="<%= slot.start_time.to_date.strftime('%m/%dï¼ˆ%aï¼‰') %>"
                            style="<%= is_reserved ? '' : 'cursor: pointer;' %>"
                            <%= 'disabled' if is_reserved %>
                          >
                            <% if is_reserved %>
                              <span class="reserved-text">äºˆç´„æ¸ˆ</span>
                            <% else %>
                              <span class="available-text">ç©ºã</span>
                            <% end %>
            </button>
                        <% else %>
                          <span class="text-gray-400 text-sm">-</span>
                        <% end %>
                      </td>
          <% end %>
                  </tr>
      <% end %>
              </tbody>
            </table>
    </div>
  </div>

  <!-- hidden_field ã« slot_id ã‚’ã‚»ãƒƒãƒˆ -->
  <%= f.hidden_field :slot_id, id: "reservation_slot_id", data: { calendar_target: "slotInput" } %>
      </div>

      <!-- ç›´æ¥JavaScript -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          console.log('DOM loaded, setting up calendar buttons');
          
          // å…¨ã¦ã®æ™‚é–“æ ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
          const buttons = document.querySelectorAll('.calendar-slot-btn');
          console.log('Found buttons:', buttons.length);
          
          buttons.forEach(function(button) {
            if (!button.disabled) {
              button.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Button clicked:', this.dataset.slotId);
                
                // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                buttons.forEach(function(btn) {
                  if (!btn.disabled) {
                    btn.style.backgroundColor = '#dbeafe';
                    btn.style.color = '#1d4ed8';
                    btn.style.border = 'none';
                    btn.style.boxShadow = 'none';
                  }
                });
                
                // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                this.style.backgroundColor = '#0ea5e9';
                this.style.color = '#ffffff';
                this.style.border = '2px solid #0ea5e9';
                this.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
                
                // hidden fieldã«å€¤ã‚’ã‚»ãƒƒãƒˆ
                const slotInput = document.getElementById('reservation_slot_id');
                if (slotInput) {
                  slotInput.value = this.dataset.slotId;
                }
                

              });
            }
          });
        });
      </script>

      <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ’‡â€â™€ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ</h2>
        
        <div class="space-y-4">
  <div>
            <%= f.label :menu_id, "æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.collection_select :menu_id, @menus, :id, :display_name, 
                { prompt: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„" }, 
                { class: "w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" } %>
          </div>
        </div>
  </div>

    <%# äºˆç´„ã«å¿…è¦ãªå€¤ã‚’å–å¾— %>
    <% slot_id = @reservation.slot_id || '' %>
    <% menu_id = @reservation.menu_id || '' %>
    <% user_id = @reservation.user_id || (current_user&.id) || '' %>

  <!-- é¸æŠå†…å®¹ã®ç¢ºèªã‚«ãƒ¼ãƒ‰ï¼ˆæ–™é‡‘ã¯é™¤å¤–ï¼‰ -->
  <div class="mb-6">
    <div class="bg-white rounded-xl shadow p-4 flex flex-col items-center">
      <div class="text-lg font-semibold text-gray-700 mb-2">é¸æŠå†…å®¹ã®ç¢ºèª</div>
      <div class="flex flex-col gap-1 text-gray-600">
        <div>ğŸ—“ï¸ æ—¥ä»˜ï¼š<span id="selected-date" class="font-bold">æœªé¸æŠ</span></div>
        <div>ğŸ•’ æ™‚é–“ï¼š<span id="selected-time" class="font-bold">æœªé¸æŠ</span></div>
        <div>ğŸ’‡â€â™€ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼š<span id="selected-menu" class="font-bold">æœªé¸æŠ</span></div>
      </div>
    </div>
  </div>

  <!-- æ³¨æ„æ›¸ã -->
  <div class="text-sm text-gray-500 text-center mb-2">
    â€»å†…å®¹ã‚’ã”ç¢ºèªã®ã†ãˆã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
  </div>

  <!-- äºˆç´„ãƒœã‚¿ãƒ³ï¼ˆæ³¨æ„æ›¸ãç›´ä¸‹ã€é€šå¸¸é…ç½®ï¼‰ -->
  <div class="w-full sm:w-auto flex flex-col items-center justify-center mt-2 mb-4">
    <button type="submit" class="reserve-btn">
      <span class="icon">ğŸ“…</span>
      <span class="label">ã“ã®å†…å®¹ã§äºˆç´„ã—ã¾ã™</span>
      <span class="sub">ã‚¿ãƒƒãƒ—ã§äºˆç´„ãŒç¢ºå®šã—ã¾ã™</span>
    </button>
  </div>

  <!-- é¸æŠå†…å®¹ã‚’JSã§åæ˜ ï¼ˆæ–™é‡‘éƒ¨åˆ†ã®å‡¦ç†ã¯å‰Šé™¤ï¼‰ -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // æ—¥ä»˜ãƒ»æ™‚é–“
      document.querySelectorAll('.calendar-slot-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          if (!btn.disabled) {
            document.getElementById('selected-date').textContent = btn.dataset.slotDate || 'æœªé¸æŠ';
            document.getElementById('selected-time').textContent = btn.dataset.slotTime || 'æœªé¸æŠ';
          }
        });
      });
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      var menuSelect = document.getElementById('reservation_menu_id') || document.querySelector('[name="reservation[menu_id]"]');
      if (menuSelect) {
        menuSelect.addEventListener('change', function() {
          var selected = menuSelect.options[menuSelect.selectedIndex];
          document.getElementById('selected-menu').textContent = selected.text || 'æœªé¸æŠ';
        });
        // åˆæœŸå€¤
        if (menuSelect.selectedIndex > 0) {
          var selected = menuSelect.options[menuSelect.selectedIndex];
          document.getElementById('selected-menu').textContent = selected.text || 'æœªé¸æŠ';
        }
      }
    });
  </script>
<% end %>

